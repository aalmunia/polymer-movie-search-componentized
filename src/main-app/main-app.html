<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../movie-search-form/movie-search-form.html">
<link rel="import" href="../dummy-component/dummy-component.html">
<link rel="import" href="../movie-list/movie-list.html">
<link rel="import" href="../movie-detail/movie-detail.html">
<link rel="import" href="../paginator/paginator.html">

<dom-module id="main-app">
  <template>
    <style>
      :host {
        width: 800px;
        height: 800px;
        font-family: monospace;
        font-size: 16pt;
      }
    </style>
    
    <div>
      <movie-search-form></movie-search-form>
      <movie-list 
        movies="[[ movies ]]"></movie-list>
      <movie-detail 
        title="[[ activeMovie.Title ]]" 
        year="[[ activeMovie.Year ]]"
        type="[[ activeMovie.Type ]]"
        poster="[[ activeMovie.Poster ]]"></movie-detail>
        <swc-paginator 
          total-elements="[[ paginatorTotalElements ]]"
          elements-per-page="[[ paginatorElementsPerPage ]]"></swc-paginator>
      <iron-ajax id="myxhr" on-response="handleSearchNewResults"></iron-ajax>
    </div>

  </template>

  <script>
    /**
     * IMPORTANTÍSIMO: Los componentes no deben escuchar los eventos de otros componentes,
     * esta clase Aplicación nos sirve de orquestador de componentes. Debe escuchar los eventos
     * de sus hijos y comuncárselos a otros hijos, pero no rompas el encapsulamiento en esto
     */
    var urlOMDB = 'http://www.omdbapi.com/?apikey=e477ed6a';
    /**
     * @customElement
     * @polymer
     */
    class MainApp extends Polymer.Element {
      static get is() { return 'main-app'; }
      static get properties() {
        return {
          movies: {
            type: Array
          },
          activeMovie: {
            isActive: {
              type: Boolean,
              value: false
            },
            Title: {
              type: String,
              value: ''
            },
            Year: {
              type: String,
              value: ''
            },
            Type: {
              type: String,
              value: ''
            },
            Poster: {
              type: String,
              value: ''
            }
          },
          paginatorTotalElements: {
            type: Number,
            value: 0
          },
          paginatorElementsPerPage: {
            type: Number,
            value: 10
          },
          searchValues: {
            title: {
              type: String,
              value: ''
            },
            year: {
              type: String,
              value: ''
            },
            type: {
              type: String,
              value: ''
            },
            page: {
              type: Number,
              value: 0
            }
          }
        };
      }

      /**
       * @class MainApp
       * @method ready
       * @description Método de ciclo de vida de componente. Inicializamos los escuchadores
       * aquí dentro
       */
      ready() {
        super.ready();
        this.addEventListener('movie-search-form-new-search', (event) => {
          this.searchValues = event.detail;
          this.parseSearchParams(event.detail);
        });
        this.addEventListener('movie-search-new-results', (event) => {
          this.movies = event.detail.movies;
          this.paginatorTotalElements = event.detail.totalResults;
        });
        this.addEventListener('movie-search-movie-detail', (event) => {          
          this.activeMovie = event.detail.movie;
        });
        this.addEventListener('paginator-new-page', (event) => {
          this.set('searchValues.page', event.detail.page);
          this.parseSearchParams(this.searchValues);
        });
      }

      /**
       * @method parseSearchParams
       * @param {String} title El texto a buscar en el título de la película
       */
      parseSearchParams(params) {
        let goodURL = urlOMDB;
        goodURL += (params.title !== '') ? '&s=' + params.title : '';
        goodURL += (params.year !== '') ? '&y=' + params.year : '';
        goodURL += (params.type !== '') ? '&type=' + params.type : '';
        goodURL += (params.page !== 0) ? '&page=' + params.page : '';
        this.$.myxhr.url = goodURL;
        this.$.myxhr.generateRequest();
      }

      handleSearchNewResults(event, request) {
        let resultRaw = request.parseResponse();
        let total = resultRaw.totalResults;
        let resultData = resultRaw.Search;
        this.dispatchEvent(new CustomEvent('movie-search-new-results', {
          detail: {
            movies: resultData,
            totalResults: total
          }
        }));
      }
    }

    window.customElements.define(MainApp.is, MainApp);
  </script>
</dom-module>
